{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
  .login-container {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 30px 0 80px 0;
}

.login-card {
    background: white;
    border-radius: 20px;
    border: 1px solid #ddd;
    padding: 40px;
    width: 100%;
    max-width: 600px;
    margin: 0 auto;
    text-align: center;
}

.login-title {
    font-size: 24px;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
}

.login-subtitle {
    color: #666;
    font-size: 14px;
    margin-bottom: 30px;
    line-height: 1.5;
}

.google-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 10px;
    background: white;
    color: #333;
    text-decoration: none;
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 30px;
    transition: box-shadow 0.2s;
}

.google-btn:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    text-decoration: none;
    color: #333;
}

.google-icon {
    margin-right: 10px;
}

.divider {
    color: #666;
    margin-bottom: 20px;
    font-size: 14px;
}

.form-messages {
    margin-bottom: 20px;
}

.message {
    padding: 12px 16px;
    margin-bottom: 10px;
    border-radius: 10px;
    font-size: 14px;
    text-align: left;
}

.message-error {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

.message-success {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.message-warning {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
}

.message-info {
    background-color: #cce7ff;
    border: 1px solid #b6d7ff;
    color: #004085;
}

.form-group {
    margin-bottom: 15px;
    text-align: left;
}

form label {
    display: block;
    margin-bottom: 8px;
    color: #333;
    font-weight: 500;
    font-size: 14px;
}

form input[type="text"],
form input[type="email"],
form input[type="password"] {
    width: 100%;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 10px;
    font-size: 16px;
    outline: none;
    transition: border-color 0.2s;
    background: #ffffff;
}

form input[type="text"]:focus,
form input[type="email"]:focus,
form input[type="password"]:focus {
    border-color: #007bff;
}

form input[type="text"]::placeholder,
form input[type="email"]::placeholder,
form input[type="password"]::placeholder {
    color: #999;
}

.password-field {
    position: relative;
}

.password-toggle {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    color: #666;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
    font-size: 20px;
}

.password-toggle.show {
    opacity: 1;
    visibility: visible;
}

.progress-requirements {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 15px;
    margin: 15px 0 20px 0;
    text-align: left;
}

.progress-requirement {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    font-size: 13px;
    transition: all 0.3s ease;
}

.progress-requirement:last-child {
    margin-bottom: 0;
}

.requirement-icon {
    margin-right: 8px;
    font-size: 16px;
    width: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.progress-requirement.invalid {
    color: #dc3545;
}

.progress-requirement.valid {
    color: #28a745;
}

.progress-requirement.invalid .requirement-icon {
    color: #dc3545;
}

.progress-requirement.valid .requirement-icon {
    color: #28a745;
}

.errorlist {
    list-style: none;
    margin: 5px 0 0 0;
    padding: 0;
}

.errorlist li {
    color: #721c24;
    font-size: 13px;
    margin-top: 5px;
}

.button-group {
    display: flex;
    gap: 15px;
    margin-top: 20px;
}

.login-btn {
    flex: 1;
    padding: 15px;
    background-color: #228b22;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s;
    text-align: center;
}

.login-btn:hover {
    background-color: #20a820;
}

.cancel-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 15px;
    background: #f8f9fa;
    color: #666;
    text-decoration: none;
    border: 1px solid #ddd;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.2s;
    text-align: center;
    box-sizing: border-box;
}

.cancel-btn:hover {
    background: #e9ecef;
    text-decoration: none;
    color: #495057;
}

.links {
    font-size: 14px;
}

.links a {
    color: #3b82f6;
    text-decoration: none;
}

.links a:hover {
    text-decoration: underline;
}

.forgot-password {
    margin-bottom: 10px;
}

.text-muted {
    color: #666;
}

@media (max-width: 768px) {
    .login-card {
        padding: 30px 20px;
        margin: 15px;
    }
    
    .login-container {
        margin-top: -20px;
    }
    
    .button-group {
        flex-direction: column;
        gap: 10px;
    }
    
    .progress-requirements {
        padding: 12px;
    }
    
    .progress-requirement {
        font-size: 12px;
        margin-bottom: 6px;
    }
}
</style>
<div class="login-container">
  <div class="login-card">
    <h2 class="login-title">Change Password</h2>
    <p class="login-subtitle">
      Enter your new password below to update your account security.
    </p>

    <form method="post">
      {% csrf_token %}
      
      <div class="form-messages">
        {% if form.non_field_errors %}
          {% for error in form.non_field_errors %}
            <div class="message message-error">{{ error }}</div>
          {% endfor %}
        {% endif %}
      </div>

      {% if form.oldpassword %}
      <div class="form-group">
        {{ form.oldpassword.label_tag }}
        <div class="password-field">
          {{ form.oldpassword }}
          <button
            type="button"
            class="password-toggle"
            onclick="togglePasswordField('{{ form.oldpassword.id_for_label }}')"
            id="old-password-toggle-btn"
          >
            <i class='bx bx-show eye-icon'></i>
          </button>
        </div>
        {% if form.oldpassword.errors %}
          <ul class="errorlist">
            {% for error in form.oldpassword.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
      {% endif %}

      <div class="form-group">
        {{ form.password1.label_tag }}
        <div class="password-field">
          {{ form.password1 }}
          <button
            type="button"
            class="password-toggle"
            onclick="togglePasswordField('{{ form.password1.id_for_label }}')"
            id="new-password-toggle-btn"
          >
            <i class='bx bx-show eye-icon'></i>
          </button>
        </div>
        {% if form.password1.errors %}
          <ul class="errorlist">
            {% for error in form.password1.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>

      <div class="progress-requirements">
        <div class="progress-requirement" id="req-uppercase">
          <span class="requirement-icon"><i class='bx bx-x'></i></span>
          Uppercase letter
        </div>
        <div class="progress-requirement" id="req-lowercase">
          <span class="requirement-icon"><i class='bx bx-x'></i></span>
          Lowercase letter
        </div>
        <div class="progress-requirement" id="req-length">
          <span class="requirement-icon"><i class='bx bx-x'></i></span>
          8+ characters
        </div>
        <div class="progress-requirement" id="req-number">
          <span class="requirement-icon"><i class='bx bx-x'></i></span>
          Number/Special char
        </div>
      </div>

      <div class="form-group">
        {{ form.password2.label_tag }}
        <div class="password-field">
          {{ form.password2 }}
          <button
            type="button"
            class="password-toggle"
            onclick="togglePasswordField('{{ form.password2.id_for_label }}')"
            id="confirm-password-toggle-btn"
          >
            <i class='bx bx-show eye-icon'></i>
          </button>
        </div>
        {% if form.password2.errors %}
          <ul class="errorlist">
            {% for error in form.password2.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>

      <div class="button-group">
        <button type="submit" class="login-btn">Change Password</button>
        <a href="{% url 'account_login' %}" class="cancel-btn">Cancel</a>
      </div>
    </form>
  </div>
</div>

<script>
  function togglePasswordField(fieldId) {
    const passwordInput = document.getElementById(fieldId);
    const toggleButton = passwordInput.nextElementSibling;
    const eyeIcon = toggleButton.querySelector('.eye-icon');

    if (passwordInput.type === "password") {
      passwordInput.type = "text";
      eyeIcon.className = 'bx bx-hide eye-icon';
    } else {
      passwordInput.type = "password";
      eyeIcon.className = 'bx bx-show eye-icon';
    }
  }

  function setupPasswordToggle(inputId, toggleId) {
    const passwordInput = document.getElementById(inputId);
    const toggleButton = document.getElementById(toggleId);

    function updateToggleVisibility() {
      if (passwordInput.value.length > 0) {
        toggleButton.classList.add("show");
      } else {
        toggleButton.classList.remove("show");
      }
    }

    updateToggleVisibility();
    passwordInput.addEventListener("input", updateToggleVisibility);
    passwordInput.addEventListener("keyup", updateToggleVisibility);
    passwordInput.addEventListener("paste", function() {
      setTimeout(updateToggleVisibility, 10);
    });
  }

  function checkPasswordRequirements(password) {
    const requirements = {
      uppercase: /[A-Z]/.test(password),
      lowercase: /[a-z]/.test(password),
      length: password.length >= 8,
      number: /[0-9!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
    };

    Object.keys(requirements).forEach(req => {
      const element = document.getElementById(`req-${req}`);
      const icon = element.querySelector('.requirement-icon i');
      
      if (requirements[req]) {
        element.classList.add('valid');
        element.classList.remove('invalid');
        icon.className = 'bx bx-check';
      } else {
        element.classList.add('invalid');
        element.classList.remove('valid');
        icon.className = 'bx bx-x';
      }
    });
  }

  document.addEventListener("DOMContentLoaded", function() {
    {% if form.oldpassword %}
    setupPasswordToggle("{{ form.oldpassword.id_for_label }}", "old-password-toggle-btn");
    {% endif %}
    setupPasswordToggle("{{ form.password1.id_for_label }}", "new-password-toggle-btn");
    setupPasswordToggle("{{ form.password2.id_for_label }}", "confirm-password-toggle-btn");

    const passwordInput = document.getElementById("{{ form.password1.id_for_label }}");
    passwordInput.addEventListener("input", function() {
      checkPasswordRequirements(this.value);
    });

    checkPasswordRequirements("");
  });
</script>
{% endblock %}