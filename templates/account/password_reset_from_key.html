{% extends 'base.html' %} {% load static %} {% block title %} Reset JoouStay
Password {% endblock %} {% block content %}
<link
  rel="stylesheet"
  href="{% static 'css/accounts/password_reset_from_key.css' %}"
/>

<div class="login-container">
  <div class="login-card">
    {% if token_fail %}
    <div class="expired-token">
      <div class="expired-icon">
        <i class="bx bx-error-circle"></i>
      </div>
      <h2 class="login-title">Reset Link Expired</h2>
      <p class="login-subtitle">
        This password reset link has expired or is invalid. Please request a new
        password reset link.
      </p>
      <div class="links">
        <a href="{% url 'account_reset_password' %}">Request New Reset Link</a>
        |
        <a href="{% url 'account_login' %}">Back to Login</a>
      </div>
    </div>
    {% else %}
    <h2 class="login-title">Set New Password</h2>
    <p class="login-subtitle">
      Enter your new password below to complete the password reset process.
    </p>

    <!-- Display messages -->
    <div class="form-messages">
      {% if messages %} {% for message in messages %}
      <div
        class="message message-{% if message.tags == 'error' %}error{% elif message.tags == 'success' %}success{% elif message.tags == 'warning' %}warning{% else %}info{% endif %}"
      >
        {{ message }}
      </div>
      {% endfor %} {% endif %} {% if form.non_field_errors %} 
      {% for error in form.non_field_errors %}
      <div class="message message-error">{{ error }}</div>
      {% endfor %} {% endif %}
    </div>

    <form method="post">
      {% csrf_token %}

      <div class="form-group">
        {{ form.password1.label_tag }}
        <div class="password-field">
          {{ form.password1 }}
          <button
            type="button"
            class="password-toggle"
            onclick="togglePasswordField('{{ form.password1.id_for_label }}')"
            id="new-password-toggle-btn"
          >
            <i class="bx bx-show eye-icon"></i>
          </button>
        </div>
        {% if form.password1.errors %}
        <ul class="errorlist">
          {% for error in form.password1.errors %}
          <li>{{ error }}</li>
          {% endfor %}
        </ul>
        {% endif %}
      </div>

      <div class="progress-requirements">
        <div class="progress-requirement" id="req-uppercase">
          <span class="requirement-icon"><i class="bx bx-x"></i></span>
          Uppercase letter
        </div>
        <div class="progress-requirement" id="req-lowercase">
          <span class="requirement-icon"><i class="bx bx-x"></i></span>
          Lowercase letter
        </div>
        <div class="progress-requirement" id="req-length">
          <span class="requirement-icon"><i class="bx bx-x"></i></span>
          8+ characters
        </div>
        <div class="progress-requirement" id="req-number">
          <span class="requirement-icon"><i class="bx bx-x"></i></span>
          Number/Special char
        </div>
      </div>

      <div class="form-group">
        {{ form.password2.label_tag }}
        <div class="password-field">
          {{ form.password2 }}
          <button
            type="button"
            class="password-toggle"
            onclick="togglePasswordField('{{ form.password2.id_for_label }}')"
            id="confirm-password-toggle-btn"
          >
            <i class="bx bx-show eye-icon"></i>
          </button>
        </div>
        {% if form.password2.errors %}
        <ul class="errorlist">
          {% for error in form.password2.errors %}
          <li>{{ error }}</li>
          {% endfor %}
        </ul>
        {% endif %}
      </div>

      <div class="button-group">
        <button type="submit" class="login-btn">Set New Password</button>
        <a href="{% url 'account_login' %}" class="cancel-btn">Cancel</a>
      </div>
    </form>
    {% endif %}
  </div>
</div>

<script>
  function togglePasswordField(fieldId) {
    const passwordInput = document.getElementById(fieldId);
    const toggleButton = passwordInput.nextElementSibling;
    const eyeIcon = toggleButton.querySelector(".eye-icon");

    if (passwordInput.type === "password") {
      passwordInput.type = "text";
      eyeIcon.className = "bx bx-hide eye-icon";
    } else {
      passwordInput.type = "password";
      eyeIcon.className = "bx bx-show eye-icon";
    }
  }

  function setupPasswordToggle(inputId, toggleId) {
    const passwordInput = document.getElementById(inputId);
    const toggleButton = document.getElementById(toggleId);

    if (!passwordInput || !toggleButton) return;

    function updateToggleVisibility() {
      if (passwordInput.value.length > 0) {
        toggleButton.classList.add("show");
      } else {
        toggleButton.classList.remove("show");
      }
    }

    updateToggleVisibility();
    passwordInput.addEventListener("input", updateToggleVisibility);
    passwordInput.addEventListener("keyup", updateToggleVisibility);
    passwordInput.addEventListener("paste", function () {
      setTimeout(updateToggleVisibility, 10);
    });
  }

  function checkPasswordRequirements(password) {
    const requirements = {
      uppercase: /[A-Z]/.test(password),
      lowercase: /[a-z]/.test(password),
      length: password.length >= 8,
      number: /[0-9!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password),
    };

    Object.keys(requirements).forEach((req) => {
      const element = document.getElementById(`req-${req}`);
      if (!element) return;

      const icon = element.querySelector(".requirement-icon i");

      if (requirements[req]) {
        element.classList.add("valid");
        element.classList.remove("invalid");
        icon.className = "bx bx-check";
      } else {
        element.classList.add("invalid");
        element.classList.remove("valid");
        icon.className = "bx bx-x";
      }
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    // Only run if form exists (token is valid)
    const passwordForm = document.querySelector("form");
    if (!passwordForm) return;

    setupPasswordToggle(
      "{{ form.password1.id_for_label }}",
      "new-password-toggle-btn"
    );
    setupPasswordToggle(
      "{{ form.password2.id_for_label }}",
      "confirm-password-toggle-btn"
    );

    const passwordInput = document.getElementById(
      "{{ form.password1.id_for_label }}"
    );
    if (passwordInput) {
      passwordInput.addEventListener("input", function () {
        checkPasswordRequirements(this.value);
      });

      checkPasswordRequirements("");
    }
  });
</script>
{% endblock %}
