{% extends 'base.html' %} {% block title %}Roommate Listings{% endblock %} 
{% load static %} {% block content %}
<link rel="stylesheet" href="{% static 'css/core/roommate_list.css' %}" />
<style>
  .hero {
    background: url('{% static "images/default_images/roomies_template_background.jpeg" %}')
      center/cover;
  }
</style>
<div class="hero">
  <div class="hero-content">
    <h1 class="hero-title">JOOUST Hostel Sharing</h1>
    <p class="hero-subtitle">
      Find students at JOOUST who are looking to share hostels or rooms on and
      around campus.
    </p>
    <div class="search-container">
      <form class="search-form" method="GET" action="{% url 'roommate_list' %}">
        <div class="search-input-group">
          <i class="bx bx-search search-icon"></i>
          <input
            type="text"
            class="search-input"
            name="q"
            placeholder="Search by name, location, rent..."
            value="{{ query }}"
          />
          <button type="submit" class="search-btn">
            <i class="bx bx-search"></i>
            Search
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="roommate-container">
  <div class="roommate-grid" id="roommate-grid">
    <!-- Script automatically loads roommate cards -->
  </div>

  <div class="loading" id="loading">
    <div style="display: inline-block; animation: pulse 2s infinite">
      <i
        class="bx bx-loader-alt"
        style="font-size: 2rem; animation: spin 2s linear infinite"
      ></i>
    </div>
    <p>Loading more profiles...</p>
  </div>
</div>

<script>
  let currentPage = 1;
  let isLoading = false;
  let hasMoreProfiles = true;
  const query = "{{ query|default:'' }}";

  function loadMoreProfiles() {
    if (isLoading || !hasMoreProfiles) return;

    isLoading = true;
    document.getElementById("loading").classList.remove("hidden");

    const params = new URLSearchParams({
      page: currentPage + 1,
    });

    if (query) {
      params.append("q", query);
    }

    fetch(`{% url 'roommate_list' %}?${params.toString()}`, {
      headers: {
        "X-Requested-With": "XMLHttpRequest",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.profiles && data.profiles.length > 0) {
          const grid = document.getElementById("roommate-grid");
          grid.insertAdjacentHTML("beforeend", data.html);
          currentPage++;
          hasMoreProfiles = data.has_next;
        } else {
          hasMoreProfiles = false;
        }
      })
      .catch((error) => {
        console.error("Error loading profiles:", error);
      })
      .finally(() => {
        isLoading = false;
        document.getElementById("loading").classList.add("hidden");
      });
  }

  function checkScroll() {
    if (
      window.innerHeight + window.scrollY >=
      document.body.offsetHeight - 1000
    ) {
      loadMoreProfiles();
    }
  }

  window.addEventListener("scroll", checkScroll);

  const style = document.createElement("style");
  style.textContent = `
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
`;
  document.head.appendChild(style);
</script>

{% endblock %}
